name: Build Unity Mono Patcher dylib

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allows you to run this workflow manually

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Build dylib with osxcross Docker Image
      run: |
        # Use the public osxcross Docker image for cross-compilation.
        # Mount the current directory into /project inside the container.
        docker run --rm -v "$(pwd)":/project \
          nicograssetto/osxcross:latest \
          /bin/bash -c "
            cd /project && \
            o64-clang++ -dynamiclib \
            -arch arm64 \
            -miphoneos-version-min=13.0 \
            -isysroot /osxcross/target/SDK/iPhoneOS.sdk \
            -o UnityMonoPatcher.dylib \
            UnityMonoPatcher.cpp \
            -framework CoreFoundation \
            -lc++ && \
            echo 'Dylib compilation successful.'
          "

    - name: Upload dylib Artifact
      uses: actions/upload-artifact@v4
      with:
        name: UnityMonoPatcher-arm64
        path: UnityMonoPatcher.dylib
        retention-days: 30
