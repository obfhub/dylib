name: Build iOS Dylib

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allows you to run this manually from the GitHub Actions tab

jobs:
  build:
    # Use a macOS runner as it has Xcode and the iOS SDK
    runs-on: macos-latest

    steps:
    # 1. Check out your repository code
    - name: Check out code
      uses: actions/checkout@v4

    # 2. Compile the .dylib file using clang
    - name: Compile Dylib
      run: |
        # Define the SDK path and other flags
        SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
        MIN_IOS_VERSION=13.0
        ARCHS="arm64 x86_64" # For device and simulator

        # Compile for arm64 (physical device)
        clang -dynamiclib \
          -arch arm64 \
          -isysroot $SDK_PATH \
          -mios-version-min=$MIN_IOS_VERSION \
          -framework Foundation \
          -framework UIKit \
          -framework UserNotifications \
          -framework CoreLocation \
          -framework Contacts \
          -framework Photos \
          -o libInstagramSpyware_arm64.dylib \
          InstagramSpyware.m

        # Compile for x86_64 (iOS Simulator)
        # Note: We use the simulator SDK here
        SIM_SDK_PATH=$(xcrun --sdk iphonesimulator --show-sdk-path)
        clang -dynamiclib \
          -arch x86_64 \
          -isysroot $SIM_SDK_PATH \
          -mios-version-min=$MIN_IOS_VERSION \
          -framework Foundation \
          -framework UIKit \
          -framework UserNotifications \
          -framework CoreLocation \
          -framework Contacts \
          -framework Photos \
          -o libInstagramSpyware_x86_64.dylib \
          InstagramSpyware.m

    # 3. (Optional) Create a universal binary for both architectures
    - name: Create Universal Binary
      run: |
        lipo -create \
          libInstagramSpyware_arm64.dylib \
          libInstagramSpyware_x86_64.dylib \
          -output libInstagramSpyware_universal.dylib

    # 4. Upload the compiled .dylib files as artifacts
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: compiled-dylibs
        path: |
          libInstagramSpyware_arm64.dylib
          libInstagramSpyware_x86_64.dylib
          libInstagramSpyware_universal.dylib
